<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeneaView – Albero genealogico (AI‑like layout)</title>
  <style>
    :root{
      --bg:#fbfaf9;--panel:#ffffff;--ink:#2e2a27;--muted:#7b6f67;--line:#cfc7c2;
      --node:#f0ebe7;--node-border:#9b877b;--shadow:0 1px 2px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .topbar{display:flex;align-items:center;gap:10px;height:52px;padding:0 16px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10}
    .brand{font-weight:700}
    .toolbar{margin-left:auto;display:flex;gap:8px}
    .btn{border:1px solid var(--line);background:#fff;height:34px;padding:0 10px;border-radius:10px;display:inline-flex;align-items:center;gap:6px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:hover{background:#f6f6f6}
    .layout{display:grid;grid-template-columns:320px 1fr;height:calc(100% - 52px)}
    .sidebar{border-right:1px solid var(--line);padding:12px;background:var(--panel);overflow:auto}
    .section{margin-bottom:16px}
    .section h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);text-transform:uppercase}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted)}
    .field input,.field select{border:1px solid var(--line);border-radius:8px;padding:6px 8px;background:#fff}
    .canvas-wrap{position:relative;overflow:auto}
    .workspace{position:relative;height:100%;padding:40px;min-width:900px;min-height:600px}
    .node{position:absolute;width:220px;min-height:90px;padding:8px;border:1px solid var(--node-border);background:var(--node);border-radius:10px;box-shadow:var(--shadow);text-align:center}
    .node .title{font-weight:700;margin-bottom:4px}
    .node .meta{font-size:12px;color:var(--muted)}
    .node .photo{width:50px;height:50px;border-radius:6px;background:#fff;border:1px solid var(--line);margin:0 auto 6px;overflow:hidden}
    canvas{position:absolute;inset:0;pointer-events:none}
  </style>
  <!-- Libreria per layout a grafo (Sugiyama) -->
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">GeneaView</div>
    <div class="toolbar">
      <button class="btn" id="btnExport">Esporta JSON</button>
      <label class="btn">Importa JSON<input id="fileInput" type="file" accept="application/json" hidden /></label>
      <button class="btn" id="btnRelayout">Ricalcola layout AI</button>
    </div>
  </header>
  <main class="layout">
    <aside class="sidebar">
      <div class="section">
        <h3>Persona</h3>
        <div class="field"><label>Nome</label><input id="pName" /></div>
        <div class="field"><label>Anno nascita</label><input id="pBirth" /></div>
        <div class="field"><label>Anno morte</label><input id="pDeath" /></div>
        <div class="field"><label>Sesso</label><select id="pGender"><option value="u">N/D</option><option value="m">M</option><option value="f">F</option></select></div>
        <div class="field"><label>Foto (URL)</label><input id="pPhoto" /></div>
        <div class="field"><button class="btn" id="btnApply">Applica</button></div>
      </div>
      <div class="section">
        <h3>Azioni</h3>
        <button class="btn" id="btnAddParent">Aggiungi genitore</button>
        <button class="btn" id="btnAddChild">Aggiungi figlio</button>
        <button class="btn" id="btnAddSpouse">Aggiungi partner</button>
        <button class="btn" id="btnDelete">Elimina</button>
      </div>
      <div class="section"><h3>Stato</h3><div id="status">Nodi: 0 · Relazioni: 0</div></div>
    </aside>
    <section class="canvas-wrap">
      <div class="workspace" id="workspace"></div>
      <canvas id="edges"></canvas>
    </section>
  </main>
  <script>
    // ===== Stato =====
    const DB={people:{},edges:[],sel:null,nextId:1,layout:'ai'}; // layout: 'ai' | 'manual'

    const ws=document.getElementById('workspace');
    const canvas=document.getElementById('edges');
    const ctx=canvas.getContext('2d');

    function resize(){canvas.width=ws.clientWidth;canvas.height=ws.clientHeight;drawEdges();}
    new ResizeObserver(resize).observe(ws);

    // ===== Helpers =====
    function newId(){return String(DB.nextId++);}    
    function rectCenter(p){return{x:(p.x||0)+110,y:(p.y||0)+45};}

    // ===== CRUD Persone =====
    function addPerson(p={}){
      const id=newId();
      DB.people[id]={id,name:'Persona',gender:'u',x:100,y:100,parents:[],...p};
      refresh();return id;
    }

    function mountPerson(p){
      const el=document.createElement('div');
      el.className='node'; el.dataset.id=p.id;
      el.style.left=(p.x||0)+'px'; el.style.top=(p.y||0)+'px';
      el.innerHTML=`<div class="photo">${p.photo?`<img src="${p.photo}" width="50" height="50"/>`:''}</div><div class="title">${p.name||'Senza nome'}</div><div class="meta">${p.birth||''}${p.death?` - ${p.death}`:''}</div>`;
      el.onclick=()=>select(p.id);
      ws.appendChild(el);
    }

    function select(id){DB.sel=id;const p=DB.people[id];document.getElementById('pName').value=p.name||'';document.getElementById('pBirth').value=p.birth||'';document.getElementById('pDeath').value=p.death||'';document.getElementById('pGender').value=p.gender||'u';document.getElementById('pPhoto').value=p.photo||'';}

    function updateStatus(){document.getElementById('status').textContent=`Nodi: ${Object.keys(DB.people).length} · Relazioni: ${DB.edges.length}`;}

    // ===== AI-like Layout con Dagre =====
    function aiLayout(){
      if(!window.dagre) return; // fallback silenzioso
      const g = new dagre.graphlib.Graph({ multigraph:true, compound:false });
      g.setGraph({ rankdir:'TB', nodesep:40, ranksep:120, marginx:40, marginy:40 });
      g.setDefaultEdgeLabel(()=>({}));

      // nodi: stessa dimensione box
      const W=220, H=90;
      for(const id in DB.people){ g.setNode(id,{ width:W, height:H }); }

      // relazioni: dai parents generiamo archi parentali
      const edges=[];
      for(const id in DB.people){
        const p=DB.people[id];
        (p.parents||[]).forEach(pr=> edges.push({a:String(pr), b:String(id), type:'parent'}));
      }
      // unisci con eventuali spouse già presenti
      DB.edges.forEach(e=> edges.push(e));

      edges.forEach((e,i)=> g.setEdge(e.a, e.b, { type:e.type||'parent' }, 'e'+i));

      dagre.layout(g);

      // scrivi posizioni sui nostri nodi
      const graph = g.graph();
      const dx = Math.max(0, (ws.clientWidth  - (graph.width  ||0)) / 2);
      const dy = Math.max(0, (ws.clientHeight - (graph.height ||0)) / 2);

      g.nodes().forEach(id=>{
        const n = g.node(id);
        if(DB.people[id]){ DB.people[id].x = Math.round((n.x - W/2) + dx); DB.people[id].y = Math.round((n.y - H/2) + dy); }
      });

      // memorizza edge points per linee ortogonali pulite
      _edgePoints = [];
      g.edges().forEach(eid=>{
        const e = g.edge(eid);
        const pts = e.points || [];
        _edgePoints.push({ a:e.v, b:e.w, type:e.type||'parent', points: pts.map(p=>({x:Math.round(p.x), y:Math.round(p.y)})) });
      });

      // sostituisci anche DB.edges (parentali) in base ai parents
      DB.edges = edges;
    }

    let _edgePoints = [];

    // ===== Render =====
    function refresh(){
      if(DB.layout==='ai') aiLayout();
      ws.innerHTML='';
      for(const id in DB.people) mountPerson(DB.people[id]);
      drawEdges(); updateStatus();
    }

    function drawEdges(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle='black'; ctx.lineWidth=1.2;

      if(DB.layout==='ai' && _edgePoints.length){
        // Usa i punti calcolati da Dagre (polilinee morbide ma dritte tra punti)
        for(const e of _edgePoints){
          const pts = e.points; if(!pts||pts.length<2) continue;
          ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
          for(let i=1;i<pts.length;i++){ ctx.lineTo(pts[i].x, pts[i].y); }
          ctx.stroke();
        }
        return;
      }

      // Fallback: gomito semplice
      for(const e of DB.edges){
        const A=DB.people[e.a], B=DB.people[e.b]; if(!A||!B) continue;
        const a=rectCenter(A), b=rectCenter(B); const midX=(a.x+b.x)/2;
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(midX,a.y); ctx.lineTo(midX,b.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      }
    }

    // ===== Toolbar Azioni =====
    document.getElementById('btnApply').onclick=()=>{
      if(!DB.sel) return; const p=DB.people[DB.sel];
      p.name=document.getElementById('pName').value; p.birth=document.getElementById('pBirth').value; p.death=document.getElementById('pDeath').value; p.gender=document.getElementById('pGender').value; p.photo=document.getElementById('pPhoto').value; refresh();
    };

    document.getElementById('btnAddParent').onclick=()=>{
      if(!DB.sel) return; const child=DB.sel; const par=addPerson({name:'Genitore'});
      DB.people[child].parents = Array.from(new Set([...(DB.people[child].parents||[]), par]));
      refresh();
    };

    document.getElementById('btnAddChild').onclick=()=>{
      if(!DB.sel) return; const par=DB.sel; const ch=addPerson({name:'Figlio'});
      DB.people[ch].parents = Array.from(new Set([...(DB.people[ch].parents||[]), par]));
      refresh();
    };

    document.getElementById('btnAddSpouse').onclick=()=>{
      if(!DB.sel) return; const sp=addPerson({name:'Partner'});
      DB.edges.push({a:DB.sel,b:sp,type:'spouse'}); // spouse non è un legame parentale
      refresh();
    };

    document.getElementById('btnDelete').onclick=()=>{
      if(!DB.sel) return; const id=DB.sel; delete DB.people[id];
      DB.edges = DB.edges.filter(e=> e.a!==id && e.b!==id);
      for(const pid in DB.people){ const pp=DB.people[pid]; if(Array.isArray(pp.parents)) pp.parents = pp.parents.filter(x=> String(x)!==String(id)); }
      DB.sel=null; refresh();
    };

    document.getElementById('btnRelayout').onclick=()=>{ DB.layout='ai'; refresh(); };

    // ===== Import/Export =====
    document.getElementById('fileInput').addEventListener('change', async (e)=>{
      try{
        const file=e.target.files && e.target.files[0];
        if(!file) return; const text=await file.text(); const data=JSON.parse(text);
        let people={}, edges=[];

        if (data && data.people){
          // tuo schema: {people:{ id:{..., parents:[...] }}, order?, nextId?}
          people = data.people; edges=[]; // edges saranno ricostruiti dal layout
          DB.nextId = data.nextId || calcNextId(people);
        } else if (data && data.nodes && data.links){
          data.nodes.forEach((p,idx)=>{
            const id=String(p.id ?? idx+1);
            people[id]={id, name:p.name||p.label||'Senza nome', x:+p.x||0, y:+p.y||0, photo:p.photo||'', parents: p.parents||[]};
          });
          edges=(data.links||[]).map(l=>({a:String(l.source), b:String(l.target), type:(l.type==='spouse'?'spouse':'parent')}));
        } else if (Array.isArray(data)){
          data.forEach((p,idx)=>{
            const id=String(p.id ?? idx+1);
            people[id]={id, name:p.name||p.title||'Senza nome', x:+p.x||0, y:+p.y||0, photo:p.photo||p.image||'', parents: p.parents||[]};
          });
        } else if (data && data.persons){
          data.persons.forEach((p,idx)=>{
            const id=String(p.id ?? idx+1);
            people[id]={id, name:p.name||'Senza nome', x:+p.x||0, y:+p.y||0, photo:p.photo||'', parents: p.parents||[]};
          });
          edges=(data.relations||[]).map(r=>({a:String(r.a||r.from), b:String(r.b||r.to), type:(r.type==='spouse'?'spouse':'parent')}));
        } else {
          alert('JSON non riconosciuto. Attesi: {people} (con parents) / [persone] / {nodes,links} / {persons,relations}.');
          return;
        }

        DB.people=people; DB.edges=edges; DB.sel=null; DB.layout='ai';
        refresh(); updateStatus();
        alert('Import completato');
      }catch(err){ console.error(err); alert('Errore import: '+(err.message||err)); }
    });

    document.getElementById('btnExport').onclick=()=>{
      const data = { people: DB.people, edges: DB.edges, nextId: DB.nextId };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='albero.json'; a.click(); URL.revokeObjectURL(url);
    };

    // ===== Seed demo minimo =====
    addPerson({name:'Nonno',x:200,y:60});
    addPerson({name:'Nonna',x:500,y:60});
    refresh();
    resize();
  </script>
</body>
</html>
